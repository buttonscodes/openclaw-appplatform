#!/bin/bash
# OpenClaw gateway service
source /etc/s6-overlay/lib/env-utils.sh
source_env_prefix OPENCLAW_

echo "[openclaw] Starting openclaw gateway..."
echo "[openclaw] DEBUG: Current user: $(whoami)"
echo "[openclaw] DEBUG: openclaw binary location: $(which openclaw 2>&1)"
echo "[openclaw] DEBUG: openclaw version: $(openclaw --version 2>&1 || echo 'no --version flag')"

# Show generated config (especially bind and auth)
echo "[openclaw] DEBUG: Config file contents:"
if [ -f /data/.openclaw/openclaw.json ]; then
    cat /data/.openclaw/openclaw.json
else
    echo "[openclaw] DEBUG: /data/.openclaw/openclaw.json NOT FOUND"
    echo "[openclaw] DEBUG: Searching for config files..."
    find / -name "openclaw.json" -o -name "openclaw.default.json" 2>/dev/null
fi

echo "[openclaw] DEBUG: Network interfaces:"
ip addr 2>/dev/null || ifconfig 2>/dev/null || echo "no ip/ifconfig available"

echo "[openclaw] DEBUG: Checking if port 18789 is already in use:"
ss -tlnp 2>/dev/null | grep 18789 || netstat -tlnp 2>/dev/null | grep 18789 || echo "port not in use"

# Allow openclaw to use tailscale
if [ "${TAILSCALE_ENABLE:-false}" = "true" ]; then
    tailscale set --operator=openclaw
fi

echo "[openclaw] DEBUG: About to start gateway..."
echo "[openclaw] DEBUG: with_env_prefix path: $(which with_env_prefix 2>&1)"

# Run gateway with stderr captured, in foreground
with_env_prefix --user openclaw OPENCLAW_ -- openclaw gateway --allow-unconfigured 2>&1
EXIT_CODE=$?
echo "[openclaw] DEBUG: Gateway exited with code: $EXIT_CODE"

# If gateway exits, sleep before restart to avoid rapid restart loop
sleep 5
